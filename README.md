Redis 3.0 集群搭建

开启两个虚拟机 分别在两个虚拟机上开启3个Redis实例 3主3从两个虚拟机里的实例互为主备

下面分别在两个虚拟机上安装，网络设置参照codis集群的前两个主机 分别关闭防火墙

1安装ruby rubygems

　　yum install ruby rubygems -y

2安装gem-redis

　　gem-redis 是ruby访问redis的接口

　　下载地址  http://rubygems.org/gems/redis/versions/3.2.1

　　上面的地址有可能访问不了或下载不了（墙的原因） 可以在csdn上下载 下载地址http://download.csdn.net/download/lihcc/8722699 解压后     

　　[root@weiguoyuan Downloads]# unzip redis-3.2.1.zip 
　　Archive: redis-3.2.1.zip
　　inflating: redis-3.2.1.gem

    [root@weiguoyuan will]# gem install -l ./Downloads/redis-3.2.1.gem
    Successfully installed redis-3.2.1
    Parsing documentation for redis-3.2.1
    Installing ri documentation for redis-3.2.1
    1 gem installed

3安装Redis3.0.2

　　wget http://download.redis.io/releases/redis-3.0.2.tar.gz

　　tar xzf redis-3.0.2.tar.gz

　　cd redis-3.0.2

　　make

4在两个机器上分别建立 6379 6380 6381 文件夹

　　[root@weiguoyuan redis-3.0.2]# mkdir 6379 6380 6381

　　[root@weiguoyuan redis-3.0.2]# cp redis.conf 6379

　　[root@weiguoyuan redis-3.0.2]# cp redis.conf 6380

　　[root@weiguoyuan redis-3.0.2]# cp redis.conf 6381

5修改Redis配置文件

　port 6379
　appendonly yes #这个是开启aof日志持久化
  cluster-enabled yes 　
  cluster-config-file nodes.conf
  cluster-node-timeout 5000
  分别修改端口 6380 6381 nodes.conf 也修改成相应端口号
6分别启动两个机器的Redis实例

　　[root@weiguoyuan src]# ./redis-server ../6379/redis.conf

　　分别换成相应的端口

7启动集群　

　　[root@weiguoyuan src]# ./redis-trib.rb create --replicas 1 10.64.4.57:6379 10.64.4.57:6380 10.64.4.57:6381 10.64.4.95:6379 10.64.4.95:6380 10.64.4.95:6381
　　>>> Creating cluster
　　Connecting to node 10.64.4.57:6379: OK
　　Connecting to node 10.64.4.57:6380: OK
　　Connecting to node 10.64.4.57:6381: OK
　　Connecting to node 10.64.4.95:6379: OK
　　Connecting to node 10.64.4.95:6380: OK
　　Connecting to node 10.64.4.95:6381: OK
　　>>> Performing hash slots allocation on 6 nodes...
　　Using 3 masters:
　　10.64.4.57:6379
　　10.64.4.95:6379
　　10.64.4.57:6380
　　Adding replica 10.64.4.95:6380 to 10.64.4.57:6379
　　Adding replica 10.64.4.57:6381 to 10.64.4.95:6379
　　Adding replica 10.64.4.95:6381 to 10.64.4.57:6380
　　M: c388f25478cb6707cf5a381f7264ab25c441bac6 10.64.4.57:6379
　　slots:0-5460 (5461 slots) master
　　M: 31ae60f5c6d35af60da4e31cb21bff1e529c53a6 10.64.4.57:6380
　　slots:10923-16383 (5461 slots) master
　　S: d4b58277d78b9a990a18074129156d8533894c6b 10.64.4.57:6381
　　replicates e921e197d25f15ab5b2616a639471f66b62ed2c7
　　M: e921e197d25f15ab5b2616a639471f66b62ed2c7 10.64.4.95:6379
　　slots:5461-10922 (5462 slots) master
　　S: ae6435077b3e1e46bed24f3ad30b041a48f61820 10.64.4.95:6380
　　replicates c388f25478cb6707cf5a381f7264ab25c441bac6
　　S: 43dae43e6a1795f8d14fb1e7d610e328af6fbe92 10.64.4.95:6381
　　replicates 31ae60f5c6d35af60da4e31cb21bff1e529c53a6


　　Can I set the above configuration? (type 'yes' to accept): yes #集群会自动分配实例的主从关系 分配后你可以接受yes
　　>>> Nodes configuration updated
　　>>> Assign a different config epoch to each node
　　>>> Sending CLUSTER MEET messages to join the cluster
　　Waiting for the cluster to join..
　　>>> Performing Cluster Check (using node 10.64.4.57:6379)
　　M: c388f25478cb6707cf5a381f7264ab25c441bac6 10.64.4.57:6379
　　slots:0-5460 (5461 slots) master
　　M: 31ae60f5c6d35af60da4e31cb21bff1e529c53a6 10.64.4.57:6380
　　slots:10923-16383 (5461 slots) master
　　M: d4b58277d78b9a990a18074129156d8533894c6b 10.64.4.57:6381
　　slots: (0 slots) master
　　replicates e921e197d25f15ab5b2616a639471f66b62ed2c7
　　M: e921e197d25f15ab5b2616a639471f66b62ed2c7 10.64.4.95:6379
　　slots:5461-10922 (5462 slots) master
　　M: ae6435077b3e1e46bed24f3ad30b041a48f61820 10.64.4.95:6380
　　slots: (0 slots) master
　　replicates c388f25478cb6707cf5a381f7264ab25c441bac6
　　M: 43dae43e6a1795f8d14fb1e7d610e328af6fbe92 10.64.4.95:6381
　　slots: (0 slots) master
　　replicates 31ae60f5c6d35af60da4e31cb21bff1e529c53a6
　　[OK] All nodes agree about slots configuration.
　　>>> Check for open slots...
　　>>> Check slots coverage...
　　[OK] All 16384 slots covered.
　　[root@weiguoyuan src]#

Redis主从切换 Sentinel

Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：

监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。
提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。
自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。
1在两个机器上分别建26379 26380 文件夹

　　[root@weiguoyuan redis-3.0.2]# mkdir 26379 26380

　　[root@weiguoyuan redis-3.0.2]# cp sentinel.conf ./26379

　　[root@weiguoyuan redis-3.0.2]# cp sentinel.conf ./26380

2修改配置文件　

　 port 26379
　　sentinel monitor weiguoyuan 10.64.4.57 6379 2

　　sentinel down-after-milliseconds weiguoyuan 60000

　　sentinel failover-timeout weiguoyuan 180000

　　sentinel parallel-syncs weiguoyuan 1

 

  　 sentinel monitor weiguoyuan2 10.64.4.95 6379 2

　　sentinel down-after-milliseconds weiguoyuan2 60000

　　sentinel failover-timeout weiguoyuan2 180000

　　sentinel parallel-syncs weiguoyuan2 1

　　#每个sentinel只需监控Master，就可以实现主从切换，不用监控slaves。

　　#每个sentinel只能监控一个主机上的一个Master，如果一个主机上有两个Master，不能用一个sentinel监控 可以多

　　#建立几个sentinel监控 否则会报下面的错误

　　[root@weiguoyuan src]# ./redis-sentinel ../26379/sentinel.conf

 

　　*** FATAL CONFIG FILE ERROR ***
　　Reading the configuration file, at line 181
　　>>> 'sentinel monitor weiguoyuan 10.64.4.57 6380 2'
　　Duplicated master name.

3sentinel监控redis实例

10.64.4.57 	                                       10.64.4.95
26379 监控实例 10.64.4.57：6379  10.64.4.95：6379	 26379 监控实例 10.64.4.57：6379  10.64.4.95：6379
26380 监控实例 10.64.4.57：6380  10.64.4.95：6379	 26380 监控实例 10.64.4.57：6380
26381 监控实例 10.64.4.57：6379 	                 26381 监控实例 10.64.4.57：6380
 

　　这样每个Master有3个sentinel监控 2个sentinel发现Master down后开始主从切换

　　参考：http://redisdoc.com/topic/sentinel.html 

主从切换出现的问题

1关于Redis的java客户端jedis的JedisCluster添加集群节点问题

　　import java.util.HashSet;
　　import java.util.Set;

　　import redis.clients.jedis.HostAndPort;
　　import redis.clients.jedis.JedisCluster;

　　public class GetRedisCluster {
　　/**
　　* 获得redis集群连接
　　* @return
　　*/
　　　　public JedisCluster getRedisCluster(){
　　　　　　Set<HostAndPort> jedisClusterNodes = new HashSet<HostAndPort>();
　　　　　　//Jedis Cluster will attempt to discover cluster nodes automatically
　　　　　　jedisClusterNodes.add(new HostAndPort("10.64.4.57", 6379));
　　　　　　jedisClusterNodes.add(new HostAndPort("10.64.4.57", 6380));
　　　　　　jedisClusterNodes.add(new HostAndPort("10.64.4.95", 6379));
　　　　　　//jedisClusterNodes.add(new HostAndPort("10.64.4.95", 6380));
　　　　　　//jedisClusterNodes.add(new HostAndPort("10.64.4.57", 6381));
　　　　　　//jedisClusterNodes.add(new HostAndPort("10.64.4.95", 6381));

　　　　　　JedisCluster jc = new JedisCluster(jedisClusterNodes,50,1000);
　　　　　　return jc;	
　　　　　　}

　　}

　　只需添加Master节点 否则报错：Exception in thread "main" redis.clients.jedis.exceptions.JedisClusterException: CLUSTERDOWN The cluster is down

2当用sentinel切换主从是有可能由于误操作导致节点中槽的分布不均 或混乱

　　在redis-cli 上执行命令　　

　　[root@weiguoyuan src]# redis-cli -c -p 6379
　　127.0.0.1:6379> cluster nodes　　

d4b58277d78b9a990a18074129156d8533894c6b 10.64.4.57:6381 master - 0 1436405568745 12 connected 5461 5463-5520 5522-5537 5539 5541-5546 5548-5555 5557-5564 5566-5582 5584-5585 5587-5609 5611-5630 5632-5635 5637-5646 5648 5650-5702 5704-5729 5731-5738 5740-5745 5747 5749-5756 5758-5759 5761-5780 5782-5826 5828-5861 5863-5870 5873-5877 5879-5880 5882-5894 5896-5904 5906-5939 5941-5969 5971-5986 5988-5991 5993-6006 6008-6011 6013-6018 6020-6036 6038-6063 6065-6101 6103-6123 6125-6130 6132-6146 6148-6164 6166-6181 6183-6207 6209 6211-6236 6238 6240-6244 6246-6247 6249-6256 6258-6262 6265-6278 6280-6288 6290-6297 6299-6305 6307-6339 6341-6362 6364-6368 6370-6410 6412-6421 6423-6445 6447-6473 6475-6484 6486-6495 6497-6501 6503-6511 6513-6526 6528-6545 6547-6603 6605 6607-6608 6610 6612-6625 6627 6629-6632 6634-6643 6645-6650 6652-6662 6664-6679 6681-6689 6691-6700 6702-6705 6707 6709-6723 6725-6786 6788-6811 6813-6821 6823-6824 6826-6831 6833-6837 6839-6847 6849-6858 6860-6924 6926-6929 6931-6966 6968-6982 6984-6992 6994-7027 7029-7048 7050-7061 7063-7090 7092-7095 7097-7106 7108-7124 7126-7151 7153-7169 7171-7185 7187 7189-7206 7208-7234 7236-7259 7261-7267 7269-7288 7290-7301 7303-7311 7313-7317 7319-7322 7324-7330 7332-7357 7359-7391 7393-7433 7435-7446 7448-7449 7451-7470 7472-7473 7475-7498 7500-7507 7509-7526 7528-7536 7538-7570 7572-7605 7607-7630 7633-7650 7652-7655 7657-7668 7670-7685 7687-7704 7706-7714 7716-7732 7734-7748 7750-7775 7777-7809 7811-7836 7838-7846 7848-7856 7858-7872 7874-7881 7883-7907 7909-7989 7991-7999 8001-8005 8007-8015 8017-8052 8054-8113 8115-8120 8122-8129 8131 8133-8147 8149-8176 8178-8195 8197-8224 8226-8240 8242-8246 8248-8262 8264-8267 8269-8274 8276-8279 8281-8319 8321-8356 8358-8370 8372 8374-8386 8388-8411 8413-8464 8466-8499 8501-8510 8512-8515 8517-8524 8526-8529 8531-8538 8540-8566 8568-8596 8598-8623 8625-8639 8641-8648 8650-8661 8663-8670 8672-8690 8692-8703 8705 8707-8712 8714-8725 8727-8732 8734 8736-8740 8742-8770 8772-8805 8807-8835 8837-8844 8846-8849 8851-8858 8860-8864 8866-8902 8904-8921 8923-8929 8931-8958 8960-8969 8971-8980 8982-9034 9036-9045 9047-9060 9062-9069 9071-9074 9076-9099 9101 9103-9104 9106 9108-9128 9130-9169 9171-9184 9186-9206 9208-9220 9222-9247 9249-9269 9271-9285 9287-9292 9294-9297 9299-9304 9306-9314 9316-9344 9346-9379 9381-9393 9395-9409 9411-9436 9438-9446 9448-9481 9483-9524 9526-9533 9535-9538 9540 9542-9547 9549-9554 9556-9561 9563-9589 9591-9648 9650-9664 9666-9670 9673-9686 9688-9693 9695-9713 9715-9728 9730 9732-9735 9737-9744 9746-9750 9752-9755 9757 9759-9763 9765-9784 9786-9830 9832-9841 9843-9860 9862-9867 9869-9874 9876 9878-9881 9883-9887 9889-9946 9948-9954 9956-9973 9975-9981 9983-9994 9996-10003 10005-10032 10034-10070 10072-10083 10085-10094 10096-10097 10099-10105 10107-10124 10126 10129 10131-10138 10140 10142-10151 10153-10164 10166-10194 10196-10207 10209-10229 10231-10245 10247-10274 10276-10299 10301-10308 10310-10335 10337-10357 10359-10369 10371-10376 10378-10406 10408-10423 10425-10432 10434-10467 10469-10481 10483-10498 10500 10502-10514 10516-10523 10525-10536 10538-10549 10551-10612 10614-10624 10626-10630 10632-10646 10649-10668 10670-10673 10675-10736 10738-10745 10747-10782 10784-10790 10792-10809 10811-10816 10818-10829 10831-10832 10834-10838 10840-10851 10853-10874 10876-10914 10916-10922
c388f25478cb6707cf5a381f7264ab25c441bac6 10.64.4.57:6379 myself,master - 0 0 9 connected 0-5460 [5462-<-d4b58277d78b9a990a18074129156d8533894c6b] [5521-<-d4b58277d78b9a990a18074129156d8533894c6b] [5538-<-d4b58277d78b9a990a18074129156d8533894c6b] [5540-<-d4b58277d78b9a990a18074129156d8533894c6b] [5547-<-d4b58277d78b9a990a18074129156d8533894c6b] [5556-<-d4b58277d78b9a990a18074129156d8533894c6b] [5565-<-d4b58277d78b9a990a18074129156d8533894c6b] [5583-<-d4b58277d78b9a990a18074129156d8533894c6b] [5586-<-d4b58277d78b9a990a18074129156d8533894c6b] [5610-<-d4b58277d78b9a990a18074129156d8533894c6b] [5631-<-e921e197d25f15ab5b2616a639471f66b62ed2c7] [5636-<-d4b58277d78b9a990a18074129156d8533894c6b] [5647-<-d4b58277d78b9a990a18074129156d8533894c6b] [5649-<-d4b58277d78b9a990a18074129156d8533894c6b] [5703-<-d4b58277d78b9a990a18074129156d8533894c6b] [5730-<-d4b58277d78b9a990a18074129156d8533894c6b] [5739-<-d4b58277d78b9a990a18074129156d8533894c6b] [5746-<-d4b58277d78b9a990a18074129156d8533894c6b] [5748-<-d4b58277d78b9a990a18074129156d8533894c6b] [5757-<-d4b58277d78b9a990a18074129156d8533894c6b] [5760-<-d4b58277d78b9a990a18074129156d8533894c6b] [5781-<-d4b58277d78b9a990a18074129156d8533894c6b] [5827-<-d4b58277d78b9a990a18074129156d8533894c6b] [5862-<-d4b58277d78b9a990a18074129156d8533894c6b] [5871-<-d4b58277d78b9a990a18074129156d8533894c6b] [5872-<-d4b58277d78b9a990a18074129156d8533894c6b] [5878-<-d4b58277d78b9a990a18074129156d8533894c6b] [5881-<-d4b58277d78b9a990a18074129156d8533894c6b] [5895-<-d4b58277d78b9a990a18074129156d8533894c6b] [5905-<-d4b58277d78b9a990a18074129156d8533894c6b] [5940-<-d4b58277d78b9a990a18074129156d8533894c6b] [5970-<-d4b58277d78b9a990a18074129156d8533894c6b] [5987-<-d4b58277d78b9a990a18074129156d8533894c6b] [5992-<-d4b58277d78b9a990a18074129156d8533894c6b] [6007-<-d4b58277d78b9a990a18074129156d8533894c6b] [6012-<-d4b58277d78b9a990a18074129156d8533894c6b] [6019-<-d4b58277d78b9a990a18074129156d8533894c6b] [6037-<-d4b58277d78b9a990a18074129156d8533894c6b] [6064-<-d4b58277d78b9a990a18074129156d8533894c6b] [6102-<-d4b58277d78b9a990a18074129156d8533894c6b] [6124-<-d4b58277d78b9a990a18074129156d8533894c6b] [6131-<-d4b58277d78b9a990a18074129156d8533894c6b] [6147-<-d4b58277d78b9a990a18074129156d8533894c6b] [6165-<-d4b58277d78b9a990a18074129156d8533894c6b] [6182-<-d4b58277d78b9a990a18074129156d8533894c6b] [6208-<-d4b58277d78b9a990a18074129156d8533894c6b] [6210-<-d4b58277d78b9a990a18074129156d8533894c6b] [6237-<-d4b58277d78b9a990a18074129156d8533894c6b] [6239-<-d4b58277d78b9a990a18074129156d8533894c6b] [6245-<-d4b58277d78b9a990a18074129156d8533894c6b] [6248-<-d4b58277d78b9a990a18074129156d8533894c6b] [6257-<-e921e197d25f15ab5b2616a639471f66b62ed2c7] [6263-<-d4b58277d78b9a990a18074129156d8533894c6b] [6264-<-d4b58277d78b9a990a18074129156d8533894c6b] [6279-<-d4b58277d78b9a990a18074129156d8533894c6b] [6289-<-d4b58277d78b9a990a18074129156d8533894c6b] [6298-<-d4b58277d78b9a990a18074129156d8533894c6b] [6306-<-d4b58277d78b9a990a18074129156d8533894c6b] [6340-<-d4b58277d78b9a990a18074129156d8533894c6b] [6363-<-d4b58277d78b9a990a18074129156d8533894c6b] [6369-<-d4b58277d78b9a990a18074129156d8533894c6b] [6411-<-d4b58277d78b9a990a18074129156d8533894c6b] [6422-<-d4b58277d78b9a990a18074129156d8533894c6b] [6446-<-d4b58277d78b9a990a18074129156d8533894c6b] [6474-<-d4b58277d78b9a990a18074129156d8533894c6b] [6485-<-d4b58277d78b9a990a18074129156d8533894c6b] [6496-<-d4b58277d78b9a990a18074129156d8533894c6b] [6502-<-d4b58277d78b9a990a18074129156d8533894c6b] [6512-<-d4b58277d78b9a990a18074129156d8533894c6b] [6527-<-d4b58277d78b9a990a18074129156d8533894c6b] [6546-<-d4b58277d78b9a990a18074129156d8533894c6b] [6604-<-d4b58277d78b9a990a18074129156d8533894c6b] [6606-<-d4b58277d78b9a990a18074129156d8533894c6b] [6609-<-d4b58277d78b9a990a18074129156d8533894c6b] [6611-<-d4b58277d78b9a990a18074129156d8533894c6b] [6626-<-d4b58277d78b9a990a18074129156d8533894c6b] [6628-<-d4b58277d78b9a990a18074129156d8533894c6b] [6633-<-d4b58277d78b9a990a18074129156d8533894c6b] [6644-<-d4b58277d78b9a990a18074129156d8533894c6b] [6651-<-d4b58277d78b9a990a18074129156d8533894c6b] [6663-<-d4b58277d78b9a990a18074129156d8533894c6b] [6680-<-d4b58277d78b9a990a18074129156d8533894c6b] [6690-<-d4b58277d78b9a990a18074129156d8533894c6b] [6701-<-d4b58277d78b9a990a18074129156d8533894c6b] [6706-<-d4b58277d78b9a990a18074129156d8533894c6b] [6708-<-d4b58277d78b9a990a18074129156d8533894c6b] [6724-<-d4b58277d78b9a990a18074129156d8533894c6b] [6787-<-d4b58277d78b9a990a18074129156d8533894c6b] [6812-<-d4b58277d78b9a990a18074129156d8533894c6b] [6822-<-d4b58277d78b9a990a18074129156d8533894c6b] [6825-<-d4b58277d78b9a990a18074129156d8533894c6b] [6832-<-d4b58277d78b9a990a18074129156d8533894c6b] [6838-<-d4b58277d78b9a990a18074129156d8533894c6b] [6848-<-d4b58277d78b9a990a18074129156d8533894c6b] [6859-<-d4b58277d78b9a990a18074129156d8533894c6b] [6925-<-d4b58277d78b9a990a18074129156d8533894c6b] [6930-<-d4b58277d78b9a990a18074129156d8533894c6b] [6967-<-d4b58277d78b9a990a18074129156d8533894c6b] [6983-<-d4b58277d78b9a990a18074129156d8533894c6b] [6993-<-d4b58277d78b9a990a18074129156d8533894c6b] [7028-<-d4b58277d78b9a990a18074129156d8533894c6b] [7049-<-d4b58277d78b9a990a18074129156d8533894c6b] [7062-<-d4b58277d78b9a990a18074129156d8533894c6b] [7091-<-d4b58277d78b9a990a18074129156d8533894c6b] [7096-<-d4b58277d78b9a990a18074129156d8533894c6b] [7107-<-d4b58277d78b9a990a18074129156d8533894c6b] [7125-<-d4b58277d78b9a990a18074129156d8533894c6b] [7152-<-d4b58277d78b9a990a18074129156d8533894c6b] [7170-<-d4b58277d78b9a990a18074129156d8533894c6b] [7186-<-d4b58277d78b9a990a18074129156d8533894c6b] [7188-<-d4b58277d78b9a990a18074129156d8533894c6b] [7207-<-d4b58277d78b9a990a18074129156d8533894c6b] [7235-<-d4b58277d78b9a990a18074129156d8533894c6b] [7260-<-d4b58277d78b9a990a18074129156d8533894c6b] [7268-<-d4b58277d78b9a990a18074129156d8533894c6b] [7289-<-d4b58277d78b9a990a18074129156d8533894c6b] [7302-<-d4b58277d78b9a990a18074129156d8533894c6b] [7312-<-d4b58277d78b9a990a18074129156d8533894c6b] [7318-<-d4b58277d78b9a990a18074129156d8533894c6b] [7323-<-d4b58277d78b9a990a18074129156d8533894c6b] [7331-<-d4b58277d78b9a990a18074129156d8533894c6b] [7358-<-d4b58277d78b9a990a18074129156d8533894c6b] [7392-<-d4b58277d78b9a990a18074129156d8533894c6b] [7434-<-d4b58277d78b9a990a18074129156d8533894c6b] [7447-<-d4b58277d78b9a990a18074129156d8533894c6b] [7450-<-d4b58277d78b9a990a18074129156d8533894c6b] [7471-<-d4b58277d78b9a990a18074129156d8533894c6b] [7474-<-d4b58277d78b9a990a18074129156d8533894c6b] [7499-<-d4b58277d78b9a990a18074129156d8533894c6b] [7508-<-d4b58277d78b9a990a18074129156d8533894c6b] [7527-<-d4b58277d78b9a990a18074129156d8533894c6b] [7537-<-d4b58277d78b9a990a18074129156d8533894c6b] [7571-<-d4b58277d78b9a990a18074129156d8533894c6b] [7606-<-d4b58277d78b9a990a18074129156d8533894c6b] [7631-<-d4b58277d78b9a990a18074129156d8533894c6b] [7632-<-d4b58277d78b9a990a18074129156d8533894c6b] [7651-<-d4b58277d78b9a990a18074129156d8533894c6b] [7656-<-d4b58277d78b9a990a18074129156d8533894c6b] [7669-<-d4b58277d78b9a990a18074129156d8533894c6b] [7686-<-d4b58277d78b9a990a18074129156d8533894c6b] [7705-<-d4b58277d78b9a990a18074129156d8533894c6b] [7715-<-d4b58277d78b9a990a18074129156d8533894c6b] [7733-<-d4b58277d78b9a990a18074129156d8533894c6b] [7749-<-d4b58277d78b9a990a18074129156d8533894c6b] [7776-<-d4b58277d78b9a990a18074129156d8533894c6b] [7810-<-d4b58277d78b9a990a18074129156d8533894c6b] [7837-<-d4b58277d78b9a990a18074129156d8533894c6b] [7847-<-d4b58277d78b9a990a18074129156d8533894c6b] [7857-<-d4b58277d78b9a990a18074129156d8533894c6b] [7873-<-d4b58277d78b9a990a18074129156d8533894c6b] [7882-<-d4b58277d78b9a990a18074129156d8533894c6b] [7908-<-d4b58277d78b9a990a18074129156d8533894c6b] [7990-<-d4b58277d78b9a990a18074129156d8533894c6b] [8000-<-d4b58277d78b9a990a18074129156d8533894c6b] [8006-<-d4b58277d78b9a990a18074129156d8533894c6b] [8016-<-d4b58277d78b9a990a18074129156d8533894c6b] [8053-<-d4b58277d78b9a990a18074129156d8533894c6b] [8114-<-d4b58277d78b9a990a18074129156d8533894c6b] [8121-<-d4b58277d78b9a990a18074129156d8533894c6b] [8130-<-d4b58277d78b9a990a18074129156d8533894c6b] [8132-<-d4b58277d78b9a990a18074129156d8533894c6b] [8148-<-d4b58277d78b9a990a18074129156d8533894c6b] [8177-<-d4b58277d78b9a990a18074129156d8533894c6b] [8196-<-d4b58277d78b9a990a18074129156d8533894c6b] [8225-<-d4b58277d78b9a990a18074129156d8533894c6b] [8241-<-d4b58277d78b9a990a18074129156d8533894c6b] [8247-<-d4b58277d78b9a990a18074129156d8533894c6b] [8263-<-d4b58277d78b9a990a18074129156d8533894c6b] [8268-<-d4b58277d78b9a990a18074129156d8533894c6b] [8275-<-d4b58277d78b9a990a18074129156d8533894c6b] [8280-<-d4b58277d78b9a990a18074129156d8533894c6b] [8320-<-d4b58277d78b9a990a18074129156d8533894c6b] [8357-<-d4b58277d78b9a990a18074129156d8533894c6b] [8371-<-d4b58277d78b9a990a18074129156d8533894c6b] [8373-<-d4b58277d78b9a990a18074129156d8533894c6b] [8387-<-d4b58277d78b9a990a18074129156d8533894c6b] [8412-<-d4b58277d78b9a990a18074129156d8533894c6b] [8465-<-d4b58277d78b9a990a18074129156d8533894c6b] [8500-<-d4b58277d78b9a990a18074129156d8533894c6b] [8511-<-d4b58277d78b9a990a18074129156d8533894c6b] [8516-<-d4b58277d78b9a990a18074129156d8533894c6b] [8525-<-d4b58277d78b9a990a18074129156d8533894c6b] [8530-<-d4b58277d78b9a990a18074129156d8533894c6b] [8539-<-d4b58277d78b9a990a18074129156d8533894c6b] [8567-<-d4b58277d78b9a990a18074129156d8533894c6b] [8597-<-d4b58277d78b9a990a18074129156d8533894c6b] [8624-<-d4b58277d78b9a990a18074129156d8533894c6b] [8640-<-d4b58277d78b9a990a18074129156d8533894c6b] [8649-<-d4b58277d78b9a990a18074129156d8533894c6b] [8662-<-d4b58277d78b9a990a18074129156d8533894c6b] [8671-<-d4b58277d78b9a990a18074129156d8533894c6b] [8691-<-d4b58277d78b9a990a18074129156d8533894c6b] [8704-<-d4b58277d78b9a990a18074129156d8533894c6b] [8706-<-d4b58277d78b9a990a18074129156d8533894c6b] [8713-<-d4b58277d78b9a990a18074129156d8533894c6b] [8726-<-d4b58277d78b9a990a18074129156d8533894c6b] [8733-<-d4b58277d78b9a990a18074129156d8533894c6b] [8735-<-d4b58277d78b9a990a18074129156d8533894c6b] [8741-<-d4b58277d78b9a990a18074129156d8533894c6b] [8771-<-d4b58277d78b9a990a18074129156d8533894c6b] [8806-<-d4b58277d78b9a990a18074129156d8533894c6b] [8836-<-d4b58277d78b9a990a18074129156d8533894c6b] [8845-<-d4b58277d78b9a990a18074129156d8533894c6b] [8850-<-d4b58277d78b9a990a18074129156d8533894c6b] [8859-<-d4b58277d78b9a990a18074129156d8533894c6b] [8865-<-d4b58277d78b9a990a18074129156d8533894c6b] [8903-<-d4b58277d78b9a990a18074129156d8533894c6b] [8922-<-d4b58277d78b9a990a18074129156d8533894c6b] [8930-<-d4b58277d78b9a990a18074129156d8533894c6b] [8959-<-d4b58277d78b9a990a18074129156d8533894c6b] [8970-<-d4b58277d78b9a990a18074129156d8533894c6b] [8981-<-d4b58277d78b9a990a18074129156d8533894c6b] [9035-<-d4b58277d78b9a990a18074129156d8533894c6b] [9046-<-d4b58277d78b9a990a18074129156d8533894c6b] [9061-<-d4b58277d78b9a990a18074129156d8533894c6b] [9070-<-d4b58277d78b9a990a18074129156d8533894c6b] [9075-<-d4b58277d78b9a990a18074129156d8533894c6b] [9100-<-d4b58277d78b9a990a18074129156d8533894c6b] [9102-<-d4b58277d78b9a990a18074129156d8533894c6b] [9105-<-d4b58277d78b9a990a18074129156d8533894c6b] [9107-<-d4b58277d78b9a990a18074129156d8533894c6b] [9129-<-d4b58277d78b9a990a18074129156d8533894c6b] [9170-<-d4b58277d78b9a990a18074129156d8533894c6b] [9185-<-d4b58277d78b9a990a18074129156d8533894c6b] [9207-<-d4b58277d78b9a990a18074129156d8533894c6b] [9221-<-d4b58277d78b9a990a18074129156d8533894c6b] [9248-<-d4b58277d78b9a990a18074129156d8533894c6b] [9270-<-d4b58277d78b9a990a18074129156d8533894c6b] [9286-<-d4b58277d78b9a990a18074129156d8533894c6b] [9293-<-d4b58277d78b9a990a18074129156d8533894c6b] [9298-<-d4b58277d78b9a990a18074129156d8533894c6b] [9305-<-d4b58277d78b9a990a18074129156d8533894c6b] [9315-<-d4b58277d78b9a990a18074129156d8533894c6b] [9345-<-d4b58277d78b9a990a18074129156d8533894c6b] [9380-<-d4b58277d78b9a990a18074129156d8533894c6b] [9394-<-d4b58277d78b9a990a18074129156d8533894c6b] [9410-<-d4b58277d78b9a990a18074129156d8533894c6b] [9437-<-d4b58277d78b9a990a18074129156d8533894c6b] [9447-<-d4b58277d78b9a990a18074129156d8533894c6b] [9482-<-d4b58277d78b9a990a18074129156d8533894c6b] [9525-<-d4b58277d78b9a990a18074129156d8533894c6b] [9534-<-d4b58277d78b9a990a18074129156d8533894c6b] [9539-<-d4b58277d78b9a990a18074129156d8533894c6b] [9541-<-d4b58277d78b9a990a18074129156d8533894c6b] [9548-<-d4b58277d78b9a990a18074129156d8533894c6b] [9555-<-d4b58277d78b9a990a18074129156d8533894c6b] [9562-<-d4b58277d78b9a990a18074129156d8533894c6b] [9590-<-d4b58277d78b9a990a18074129156d8533894c6b] [9649-<-d4b58277d78b9a990a18074129156d8533894c6b] [9665-<-d4b58277d78b9a990a18074129156d8533894c6b] [9671-<-d4b58277d78b9a990a18074129156d8533894c6b] [9672-<-d4b58277d78b9a990a18074129156d8533894c6b] [9687-<-d4b58277d78b9a990a18074129156d8533894c6b] [9694-<-d4b58277d78b9a990a18074129156d8533894c6b] [9714-<-d4b58277d78b9a990a18074129156d8533894c6b] [9729-<-d4b58277d78b9a990a18074129156d8533894c6b] [9731-<-d4b58277d78b9a990a18074129156d8533894c6b] [9736-<-d4b58277d78b9a990a18074129156d8533894c6b] [9745-<-d4b58277d78b9a990a18074129156d8533894c6b] [9751-<-d4b58277d78b9a990a18074129156d8533894c6b] [9756-<-d4b58277d78b9a990a18074129156d8533894c6b] [9758-<-d4b58277d78b9a990a18074129156d8533894c6b] [9764-<-d4b58277d78b9a990a18074129156d8533894c6b] [9785-<-d4b58277d78b9a990a18074129156d8533894c6b] [9831-<-d4b58277d78b9a990a18074129156d8533894c6b] [9842-<-d4b58277d78b9a990a18074129156d8533894c6b] [9861-<-d4b58277d78b9a990a18074129156d8533894c6b] [9868-<-d4b58277d78b9a990a18074129156d8533894c6b] [9875-<-d4b58277d78b9a990a18074129156d8533894c6b] [9877-<-d4b58277d78b9a990a18074129156d8533894c6b] [9882-<-d4b58277d78b9a990a18074129156d8533894c6b] [9888-<-d4b58277d78b9a990a18074129156d8533894c6b] [9947-<-d4b58277d78b9a990a18074129156d8533894c6b] [9955-<-d4b58277d78b9a990a18074129156d8533894c6b] [9974-<-d4b58277d78b9a990a18074129156d8533894c6b] [9982-<-d4b58277d78b9a990a18074129156d8533894c6b] [9995-<-d4b58277d78b9a990a18074129156d8533894c6b] [10004-<-d4b58277d78b9a990a18074129156d8533894c6b] [10033-<-d4b58277d78b9a990a18074129156d8533894c6b] [10071-<-d4b58277d78b9a990a18074129156d8533894c6b] [10084-<-d4b58277d78b9a990a18074129156d8533894c6b] [10095-<-d4b58277d78b9a990a18074129156d8533894c6b] [10098-<-d4b58277d78b9a990a18074129156d8533894c6b] [10106-<-d4b58277d78b9a990a18074129156d8533894c6b] [10125-<-d4b58277d78b9a990a18074129156d8533894c6b] [10127-<-d4b58277d78b9a990a18074129156d8533894c6b] [10128-<-d4b58277d78b9a990a18074129156d8533894c6b] [10130-<-d4b58277d78b9a990a18074129156d8533894c6b] [10139-<-e921e197d25f15ab5b2616a639471f66b62ed2c7] [10141-<-d4b58277d78b9a990a18074129156d8533894c6b] [10152-<-d4b58277d78b9a990a18074129156d8533894c6b] [10165-<-d4b58277d78b9a990a18074129156d8533894c6b] [10195-<-d4b58277d78b9a990a18074129156d8533894c6b] [10208-<-d4b58277d78b9a990a18074129156d8533894c6b] [10230-<-d4b58277d78b9a990a18074129156d8533894c6b] [10246-<-d4b58277d78b9a990a18074129156d8533894c6b] [10275-<-d4b58277d78b9a990a18074129156d8533894c6b] [10300-<-d4b58277d78b9a990a18074129156d8533894c6b] [10309-<-d4b58277d78b9a990a18074129156d8533894c6b] [10336-<-d4b58277d78b9a990a18074129156d8533894c6b] [10358-<-d4b58277d78b9a990a18074129156d8533894c6b] [10370-<-d4b58277d78b9a990a18074129156d8533894c6b] [10377-<-d4b58277d78b9a990a18074129156d8533894c6b] [10407-<-d4b58277d78b9a990a18074129156d8533894c6b] [10424-<-d4b58277d78b9a990a18074129156d8533894c6b] [10433-<-d4b58277d78b9a990a18074129156d8533894c6b] [10468-<-d4b58277d78b9a990a18074129156d8533894c6b] [10482-<-d4b58277d78b9a990a18074129156d8533894c6b] [10499-<-d4b58277d78b9a990a18074129156d8533894c6b] [10501-<-d4b58277d78b9a990a18074129156d8533894c6b] [10515-<-d4b58277d78b9a990a18074129156d8533894c6b] [10524-<-d4b58277d78b9a990a18074129156d8533894c6b] [10537-<-d4b58277d78b9a990a18074129156d8533894c6b] [10550-<-d4b58277d78b9a990a18074129156d8533894c6b] [10613-<-d4b58277d78b9a990a18074129156d8533894c6b] [10625-<-d4b58277d78b9a990a18074129156d8533894c6b] [10631-<-d4b58277d78b9a990a18074129156d8533894c6b] [10647-<-d4b58277d78b9a990a18074129156d8533894c6b] [10648-<-d4b58277d78b9a990a18074129156d8533894c6b] [10669-<-d4b58277d78b9a990a18074129156d8533894c6b] [10674-<-d4b58277d78b9a990a18074129156d8533894c6b] [10737-<-d4b58277d78b9a990a18074129156d8533894c6b] [10746-<-d4b58277d78b9a990a18074129156d8533894c6b] [10783-<-d4b58277d78b9a990a18074129156d8533894c6b] [10791-<-d4b58277d78b9a990a18074129156d8533894c6b] [10810-<-d4b58277d78b9a990a18074129156d8533894c6b] [10817-<-d4b58277d78b9a990a18074129156d8533894c6b] [10830-<-d4b58277d78b9a990a18074129156d8533894c6b] [10833-<-d4b58277d78b9a990a18074129156d8533894c6b] [10839-<-d4b58277d78b9a990a18074129156d8533894c6b] [10852-<-d4b58277d78b9a990a18074129156d8533894c6b] [10875-<-d4b58277d78b9a990a18074129156d8533894c6b] [10915-<-d4b58277d78b9a990a18074129156d8533894c6b]
ae6435077b3e1e46bed24f3ad30b041a48f61820 10.64.4.95:6380 slave c388f25478cb6707cf5a381f7264ab25c441bac6 0 1436405567712 9 connected
43dae43e6a1795f8d14fb1e7d610e328af6fbe92 10.64.4.95:6381 slave 31ae60f5c6d35af60da4e31cb21bff1e529c53a6 0 1436405567186 6 connected
31ae60f5c6d35af60da4e31cb21bff1e529c53a6 10.64.4.57:6380 master - 0 1436405568223 2 connected 10923-16383
e921e197d25f15ab5b2616a639471f66b62ed2c7 10.64.4.95:6379 slave d4b58277d78b9a990a18074129156d8533894c6b 0 1436405569279 12 connected
127.0.0.1:6379>

 

发现5462槽混乱客户端也报错 Exception in thread "main" java.lang.NumberFormatException: For input string: "[5462"

 修复： 

1删除各个节点（6379 6380 6381）下redis.conf文件中指定的cluster-config-file 我的在redis-3.0.2/src 下的

nodes-6379.conf nodes-6380.conf nodes-6381.conf

2清空各个节点key

　　redis-cli -p 6390 

　　flushall

3重启下虚拟机 重新执行

　　[root@weiguoyuan src]# ./redis-trib.rb create --replicas 1 10.64.4.57:6379 10.64.4.57:6380 10.64.4.57:6381 10.64.4.95:6379 10.64.4.95:6380 10.64.4.95:6381

4查看节点状态

　　[root@weiguoyuan src]# ./redis-cli -c -p 6379
　　127.0.0.1:6379> cluster nodes
　　1688ccdbab239e514577fdffd87344ea84481263 10.64.4.57:6381 slave 16c7fb8a9d4c63b7c0712bbaae4bb70e9a24b90d 0 1436416916290 4 connected
　　16c7fb8a9d4c63b7c0712bbaae4bb70e9a24b90d 10.64.4.95:6379 master - 0 1436416915275 4 connected 5461-10922
　　eeb64c309774f05661741c14fb8875297b217f0a 10.64.4.57:6379 myself,master - 0 0 1 connected 0-5460
　　04e23f3d1abeeb40839c667e2d039a36c5172f13 10.64.4.95:6381 slave 6e6bad30189c628c4ffe356c191b9ae3e970cfd5 0 1436416917331 6 connected
　　6e6bad30189c628c4ffe356c191b9ae3e970cfd5 10.64.4.57:6380 master - 0 1436416916816 2 connected 10923-16383
　　73d80a7eb6a44136f606e4829b9954b0e0c8d4ea 10.64.4.95:6380 slave eeb64c309774f05661741c14fb8875297b217f0a 0 1436416915782 5 connected
　　127.0.0.1:6379>

 　　

在线扩容 数据迁移

使用redis-trib.rb工具 具体看第一个参考连接

参考

http://hot66hot.iteye.com/blog/2050676

http://redisdoc.com/index.html
